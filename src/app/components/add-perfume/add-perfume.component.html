<div class="page" (paste)="onPaste($event)">
  <h1>Add Perfume</h1>

  <form class="form-grid" [formGroup]="form" (ngSubmit)="save()" novalidate>
    <!-- Name -->
    <label class="field">
      <span class="label">Perfume Name</span>
      <input
        type="text"
        formControlName="name"
        placeholder="e.g., Initio Absolute Aphrodisiac"
        autocomplete="off"
      />
      <small
        class="error"
        *ngIf="form.controls.name.touched && form.controls.name.invalid"
      >
        Name is required (min 2 chars).
      </small>
    </label>

    <!-- Brand (optional) -->
    <label class="field">
      <span class="label">Brand (optional)</span>
      <select formControlName="brandId">
        <option value="">— None —</option>
        <option *ngFor="let b of brands()" [value]="b.id">{{ b.name }}</option>
      </select>
    </label>

    <!-- Description (optional) -->
    <label class="field span-2">
      <span class="label">Description (optional)</span>
      <textarea
        formControlName="description"
        rows="3"
        placeholder="Short description or notes"
      ></textarea>
    </label>

    <!-- Divider -->
    <div class="section-title span-2">
      <h2>Tags / Notes</h2>
    </div>

    <!-- Tags -->
    <div class="span-2">
      <ng-container *ngIf="tagsByGroup$ | async as g; else loadingTags">
        <fieldset class="tag-group">
          <legend>Gender</legend>
          <div class="chips">
            <label class="chip" *ngFor="let t of g.gender">
              <input
                type="checkbox"
                [checked]="form.value.tags?.includes(t.id)"
                (change)="toggleTag(t.id, $any($event.target).checked)"
              />
              <span>{{ t.name }}</span>
            </label>
          </div>
        </fieldset>

        <div class="rule"></div>

        <fieldset class="tag-group">
          <legend>Families</legend>
          <div class="chips">
            <label class="chip" *ngFor="let t of g.family">
              <input
                type="checkbox"
                [checked]="form.value.tags?.includes(t.id)"
                (change)="toggleTag(t.id, $any($event.target).checked)"
              />
              <span>{{ t.name }}</span>
            </label>
          </div>
        </fieldset>

        <div class="rule"></div>

        <fieldset class="tag-group">
          <legend>Notes</legend>
          <div class="chips">
            <label class="chip" *ngFor="let t of g.note">
              <input
                type="checkbox"
                [checked]="form.value.tags?.includes(t.id)"
                (change)="toggleTag(t.id, $any($event.target).checked)"
              />
              <span>{{ t.name }}</span>
            </label>
          </div>
        </fieldset>

        <fieldset class="tag-group" *ngIf="g.other.length">
          <legend>Other</legend>
          <div class="chips">
            <label class="chip" *ngFor="let t of g.other">
              <input
                type="checkbox"
                [checked]="form.value.tags?.includes(t.id)"
                (change)="toggleTag(t.id, $any($event.target).checked)"
              />
              <span>{{ t.name }}</span>
            </label>
          </div>
        </fieldset>
      </ng-container>

      <ng-template #loadingTags>
        <div class="muted">Loading tags…</div>
      </ng-template>
    </div>

    <!-- Divider -->
    <div class="section-title span-2">
      <h2>Image</h2>
    </div>

    <!-- Image -->
    <div
      class="dropzone span-2"
      [class.dragging]="isDragging()"
      (dragover)="onDragOver($event)"
      (dragleave)="onDragLeave($event)"
      (drop)="onDrop($event)"
    >
      <div class="dz-inner">
        <ng-container *ngIf="!imagePreviewUrl(); else hasImage">
          <p class="dz-title">Paste an image (Ctrl + V)</p>
          <p class="dz-sub">or drag & drop, or</p>
          <label class="btn">
            Choose file
            <input
              type="file"
              accept="image/*"
              (change)="onFileSelected($event)"
              hidden
            />
          </label>
        </ng-container>

        <ng-template #hasImage>
          <img [src]="imagePreviewUrl()!" alt="Preview" class="preview" />
          <button type="button" class="btn outline" (click)="removeImage()">
            Remove image
          </button>
        </ng-template>
      </div>
    </div>

    <!-- Feedback -->
    <p class="success span-2" *ngIf="successMsg()">{{ successMsg() }}</p>
    <p class="error span-2" *ngIf="errorMsg()">{{ errorMsg() }}</p>

    <!-- Actions -->
    <div class="actions sticky-actions span-2">
      <button class="btn primary" type="submit" [disabled]="saving()">
        {{ saving() ? "Saving…" : "Save Perfume" }}
      </button>
    </div>
  </form>
</div>
